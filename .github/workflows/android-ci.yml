name: Android CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  # Default package name - extracted dynamically in workflow
  DEFAULT_PACKAGE: "me.capcom.smsgateway"

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Extract package name from build.gradle
        id: package
        run: |
          # Extract applicationId with multiple pattern support
          PACKAGE=$(grep -E "applicationId\s*[=]?\s*['\"]" app/build.gradle | \
                    sed -E "s/.*applicationId\s*[=]?\s*['\"]([^'\"]+)['\"].*/\1/" | \
                    head -1)

          # Fallback to namespace if applicationId not found
          if [ -z "$PACKAGE" ]; then
            PACKAGE=$(grep -E "namespace\s*[=]?\s*['\"]" app/build.gradle | \
                      sed -E "s/.*namespace\s*[=]?\s*['\"]([^'\"]+)['\"].*/\1/" | \
                      head -1)
          fi

          # Final fallback
          PACKAGE=${PACKAGE:-$DEFAULT_PACKAGE}
          echo "package_name=$PACKAGE" >> $GITHUB_OUTPUT
          echo "Detected package: $PACKAGE"

      - name: Create google-services.json placeholder
        run: |
          PACKAGE="${{ steps.package.outputs.package_name }}"
          cat > app/google-services.json << EOF
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "sactl-signal-placeholder",
              "storage_bucket": "sactl-signal-placeholder.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                  "android_client_info": {
                    "package_name": "$PACKAGE"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "AIzaSyPlaceholderKeyForBuildOnly000000"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF
          echo "Created google-services.json for package: $PACKAGE"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: sactl-signal-debug
          path: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/debugInsecure/*.apk
          retention-days: 30
          if-no-files-found: warn

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Extract package name from build.gradle
        id: package
        run: |
          PACKAGE=$(grep -E "applicationId\s*[=]?\s*['\"]" app/build.gradle | \
                    sed -E "s/.*applicationId\s*[=]?\s*['\"]([^'\"]+)['\"].*/\1/" | \
                    head -1)
          if [ -z "$PACKAGE" ]; then
            PACKAGE=$(grep -E "namespace\s*[=]?\s*['\"]" app/build.gradle | \
                      sed -E "s/.*namespace\s*[=]?\s*['\"]([^'\"]+)['\"].*/\1/" | \
                      head -1)
          fi
          PACKAGE=${PACKAGE:-$DEFAULT_PACKAGE}
          echo "package_name=$PACKAGE" >> $GITHUB_OUTPUT

      - name: Create google-services.json placeholder
        run: |
          PACKAGE="${{ steps.package.outputs.package_name }}"
          cat > app/google-services.json << EOF
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "sactl-signal-placeholder",
              "storage_bucket": "sactl-signal-placeholder.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                  "android_client_info": {
                    "package_name": "$PACKAGE"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "AIzaSyPlaceholderKeyForBuildOnly000000"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF

      - name: Grant execute permission
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: Extract version info
        id: version
        run: |
          # Robust version extraction with multiple patterns
          # Pattern 1: versionName = "x.x.x"
          # Pattern 2: versionName "x.x.x"
          # Pattern 3: versionName='x.x.x'
          VERSION=$(grep -E "versionName\s*[=]?\s*['\"]" app/build.gradle | \
                    sed -E "s/.*versionName\s*[=]?\s*['\"]([^'\"]+)['\"].*/\1/" | \
                    head -1)

          # Fallback version if extraction fails
          VERSION=${VERSION:-"1.0.0"}

          # Extract versionCode for reference
          VERSION_CODE=$(grep -E "versionCode\s*[=]?\s*[0-9]+" app/build.gradle | \
                         sed -E "s/.*versionCode\s*[=]?\s*([0-9]+).*/\1/" | \
                         head -1)
          VERSION_CODE=${VERSION_CODE:-"1"}

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION (code: $VERSION_CODE)"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}-build.${{ github.run_number }}
          name: "[SACTL_] Signal v${{ steps.version.outputs.version }}"
          body: |
            ## [SACTL_] Signal Android v${{ steps.version.outputs.version }}

            **Provisioning shell for AI agent.**

            | Info | Value |
            |------|-------|
            | Version | ${{ steps.version.outputs.version }} |
            | Build | ${{ github.run_number }} |
            | Commit | ${{ github.sha }} |

            ### Installation
            1. Download the APK below
            2. Enable "Install from Unknown Sources" in Android settings
            3. Install the APK
            4. Grant SMS permissions when prompted

            ### Configuration
            - **Webhook URL**: `https://api.sactl.ai/v1/webhook/sms`
            - Or configure in Settings â†’ Cloud Server

            ### Notes
            - This is a **debug build** for testing
            - Firebase push notifications require real google-services.json

            ---
            *Built with [SACTL_] CI/CD Pipeline*
          files: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/release/*.apk
          fail_on_unmatched_files: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
